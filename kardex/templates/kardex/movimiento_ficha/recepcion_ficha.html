{% extends 'base.html' %}
{% load static %}

{% block title %}Recepción de Fichas{% endblock %}

{% block content %}
    <div class="container-fluid small-input">
        <div class="row">
            <div class="col-12">
                <div class="card card-primary">
                    <div class="card-header">
                        <h3 class="card-title">Filtros</h3>
                    </div>
                    <div class="card-body">
                        <form id="form-filtros" class="form" method="get">
                            <div class="form-row">
                                <div class="form-group col-md-3">
                                    <label>{{ filter_form.hora_inicio.label }}</label>
                                    {{ filter_form.hora_inicio }}
                                </div>
                                <div class="form-group col-md-3">
                                    <label for="id_hora_termino">{{ filter_form.hora_termino.label }}</label>
                                    {{ filter_form.hora_termino }}
                                </div>
                                <div class="form-group col-md-3">
                                    <label for="id_servicio_clinico">{{ filter_form.servicio_clinico.label }}</label>
                                    {{ filter_form.servicio_clinico }}
                                </div>
                                <div class="form-group col-md-3">
                                    <label for="id_profesional">{{ filter_form.profesional.label }}</label>
                                    {{ filter_form.profesional }}
                                </div>
                            </div>
                            <button class="btn btn-secondary" type="submit"><i class="fas fa-filter"></i> Aplicar
                                filtros
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <div class="card card-primary">
                    <div class="card-header">
                        <h3 class="card-title">Registro de Recepción de Ficha</h3>
                    </div>
                    <div class="card-body">
                        <form id="form-recepcion" class="form" method="post" novalidate>
                            {% csrf_token %}
                            {{ form.non_field_errors }}
                            <div class="form-row">
                                <div class="form-group col-md-3">
                                    <label class="form-check-label">{{ form.rut.label }}</label>
                                    {{ form.rut }}
                                    {% for error in form.rut.errors %}
                                        <span class="text-danger small d-block">{{ error }}</span>
                                    {% endfor %}
                                </div>
                                <div class="form-group col-md-3">
                                    <label class="form-check-label">{{ form.ficha.label }}</label>
                                    {{ form.ficha }}
                                    {% for error in form.ficha.errors %}
                                        <span class="text-danger small d-block">{{ error }}</span>
                                    {% endfor %}
                                </div>
                                <div class="form-group col-md-6">
                                    <label class="form-check-label">{{ form.nombre.label }}</label>
                                    {{ form.nombre }}
                                    {% for error in form.nombre.errors %}
                                        <span class="text-danger small d-block">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <label class="form-check-label">{{ form.servicio_clinico_envio.label }}</label>
                                        {{ form.servicio_clinico_envio }}
                                        {% for error in form.servicio_clinico_envio.errors %}
                                            <span class="text-danger small d-block">{{ error }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <label class="form-check-label">{{ form.servicio_clinico_recepcion.label }}</label>
                                        {{ form.servicio_clinico_recepcion }}
                                        {% for error in form.servicio_clinico_recepcion.errors %}
                                            <span class="text-danger small d-block">{{ error }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <label class="form-check-label">{{ form.profesional_recepcion.label }}</label>
                                        {{ form.profesional_recepcion }}
                                        {% for error in form.profesional_recepcion.errors %}
                                            <span class="text-danger small d-block">{{ error }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="col-md-12">
                                    <div class="form-check">
                                        <label class="form-check-label">{{ form.observacion_recepcion.label }}</label>
                                        {{ form.observacion_recepcion }}
                                        {% for error in form.observacion_recepcion.errors %}
                                            <span class="text-danger small d-block">{{ error }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            <button type="submit" id="btn-guardar" class="btn btn-primary mt-3"><i
                                    class="fas fa-save"></i>
                                Guardar
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex align-items-center">
                        <h3 class="card-title mb-0">Movimientos de Recepción</h3>
                        <a href="{% url 'reports:export_movimiento_ficha_recepcion_csv' %}"
                           class="btn btn-success btn-sm ml-auto">
                            <i class="fas fa-file-csv"></i> Exportar CSV
                        </a>
                    </div>


                    <div class="card-body">
                        <table id="Table" class="table table-bordered table-striped table-sm">
                            <thead>
                            <tr>
                                <th>ID</th>
                                <th>Acciones</th>
                                {% for col in columns %}
                                    {% if col != 'ID' %}
                                        <th>{{ col }}</th>
                                    {% endif %}
                                {% endfor %}
                            </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block javascript %}
    <script>
        $('.select2').select2({
            theme: 'bootstrap4',
            width: '100%'
        });
    </script>
    <script src="{% static 'js/apis/api_recepcion_ficha.js' %}"></script>
    <script>
        // Marcar campos de envío como solo lectura en UI (rut y nombre ya tienen readonly en los widgets)
        $('#servicio_clinico_ficha').prop('readonly', true);
        $('#servicio_clinico_envio_ficha').prop('readonly', true);
        // Importante: no deshabilitar #id_ficha para que el valor se envíe en el POST
        $('#id_ficha').prop('disabled', false);
        $('#nombre_mov').prop('readonly', true);
        $('#id_rut').prop('disabled', false); // sólo para buscar y cargar

        // ===== Recepción por AJAX (sin recargar la página) =====
        (function () {
            const $form = $('#form-recepcion');
            const $btn = $('#btn-guardar');

            function clearFieldErrors() {
                // Remueve mensajes de error previos generados por AJAX
                $form.find('.text-danger.small.d-block.ajax-error').remove();
                // Quita clases de error si existieran
                $form.find('.is-invalid').removeClass('is-invalid');
            }

            function showErrors(errors) {
                // errors viene como dict {field: [msg, ...]}
                for (const name in errors) {
                    if (!errors.hasOwnProperty(name)) continue;
                    const msgs = errors[name];
                    // localiza el input por su id estándar de Django: id_ + name
                    const $field = $("#id_" + name);
                    if ($field.length) {
                        $field.addClass('is-invalid');
                        const $container = $field.closest('.form-group, .form-check, .col-md-12');
                        msgs.forEach(m => {
                            $('<span class="text-danger small d-block ajax-error"></span>')
                                .text(m)
                                .appendTo($container);
                        });
                    } else {
                        // errores no asociados a campo
                        const $nonField = $('<div class="text-danger small d-block ajax-error"></div>').text(msgs.join(' '));
                        $nonField.prependTo($form);
                    }
                }
            }

            function limpiarCamposTrasExito() {
                // Limpiar los campos solicitados y mantener Profesional que recibe + Observación recepción
                // Texto
                $('#id_rut').val('');
                $('#id_ficha').val('');
                $('#id_nombre').val('');

                // Selects (Select2) de servicios clínicos de envío y recepción
                $('#id_servicio_clinico_envio').val(null).trigger('change');
                $('#id_servicio_clinico_recepcion').val(null).trigger('change');
            }

            function recargarTabla() {
                // Si existe DataTable inicializado, recargar sin resetear paginación
                const table = $('#Table').data('DataTable') || $('#Table').DataTable?.();
                if (table && table.ajax) {
                    try {
                        table.ajax.reload(null, false);
                    } catch (e) { /* noop */
                    }
                }
            }

            $form.on('submit', function (e) {
                e.preventDefault();
                clearFieldErrors();

                const formData = new FormData($form[0]);

                $btn.prop('disabled', true).addClass('disabled');

                fetch($form.attr('action') || window.location.href, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData,
                    credentials: 'same-origin'
                }).then(async resp => {
                    const contentType = resp.headers.get('content-type') || '';
                    let data = {};
                    if (contentType.includes('application/json')) {
                        data = await resp.json();
                    } else {
                        // fallback
                        const text = await resp.text();
                        try {
                            data = JSON.parse(text);
                        } catch (_) {
                            data = {ok: false, errors: {__all__: ['Respuesta inesperada del servidor.']}};
                        }
                    }
                    if (resp.ok && data.ok) {
                        // Éxito: limpiar campos indicados, mantener profesional y observación
                        limpiarCamposTrasExito();
                        recargarTabla();
                        // Opcional: feedback visual
                        if (window.Swal) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Recepción registrada',
                                timer: 1200,
                                showConfirmButton: false
                            });
                        }
                    } else {
                        // Errores de validación
                        const errs = (data && data.errors) ? data.errors : {__all__: ['No se pudo registrar la recepción.']};
                        showErrors(errs);
                        if (window.Swal) {
                            Swal.fire({icon: 'error', title: 'Error', text: 'Revise los campos del formulario.'});
                        }
                    }
                }).catch(err => {
                    showErrors({__all__: ['Error de red o servidor. Intente nuevamente.']});
                }).finally(() => {
                    $btn.prop('disabled', false).removeClass('disabled');
                });
            });
        })();
    </script>
{% endblock %}
