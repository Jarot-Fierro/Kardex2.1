{% extends 'base.html' %}
{% load static %}

{% block title %}Movimientos - {{ title|default:'Formulario' }}{% endblock %}

{% block content %}
    <div class="container-fluid">
        <div class="card shadow-sm">
            <div class="card-header">
                <h3 class="card-title mb-0">{{ title }}</h3>
            </div>

            <div class="card-body">
                <form method="post" novalidate>
                    {% csrf_token %}
                    {{ form.non_field_errors }}
                    <input type="hidden" name="action" value="{{ action|default:'add' }}">

                    <!-- Campos ocultos que no quieres mostrar -->
                    {% for field in form.hidden_fields %}
                        {{ field }}
                    {% endfor %}

                    <div class="row">
                        {% for field in form.visible_fields %}
                            {% if field.name != 'fecha_envio' and field.name != 'fecha_recepcion' and field.name != 'fecha_traspaso' %}
                                <div class="col-md-6 mb-3">
                                    <label for="{{ field.id_for_label }}" class="form-label fw-bold">
                                        {{ field.label }}
                                    </label>

                                    <div class="w-100">
                                        {{ field }}
                                    </div>

                                    {% if field.help_text %}
                                        <small class="form-text text-muted">
                                            {{ field.help_text }}
                                        </small>
                                    {% endif %}

                                    {% for error in field.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ error }}
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>

                    <hr>

                    <div class="d-flex justify-content-end">
                        <a href="{{ list_url }}" class="btn btn-secondary me-2">
                            Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary">
                            Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascript %}
    <script>
        (function () {
            // Inicialización general
            $('.select2').select2({
                theme: 'bootstrap4',
                width: '100%'
            });

            // Select de Ficha con carga por API
            var $ficha = $('#id_ficha');
            if ($ficha.length) {
                var apiUrl = $ficha.attr('data-api-url') || '/kardex/api/api_pacientes/';
                // Mantener opción actual si viene desde el servidor
                var currentOption = $ficha.find('option:selected');
                $ficha.select2({
                    theme: 'bootstrap4',
                    width: '100%',
                    placeholder: $ficha.data('placeholder') || 'Buscar por número de ficha',
                    allowClear: true,
                    minimumInputLength: 1,
                    ajax: {
                        transport: function (params, success, failure) {
                            var term = params.data.term || '';
                            if (!term) {
                                success({results: []});
                                return;
                            }
                            $.ajax({
                                url: apiUrl,
                                method: 'GET',
                                data: {numero_ficha: term},
                                success: function (resp) {
                                    // La API retorna un único registro o error
                                    var results = [];
                                    if (resp && resp.exists && resp.has_ficha && resp.data) {
                                        var d = resp.data;
                                        results.push({
                                            id: d.ficha_id,
                                            text: d.numero_ficha_sistema + ' - ' + (d.nombre || '') + ' ' + (d.apellido_paterno || '') + ' ' + (d.apellido_materno || '')
                                        });
                                    }
                                    success({results: results});
                                },
                                error: function (xhr) {
                                    failure(xhr);
                                }
                            });
                        },
                        processResults: function (data) {
                            return data;
                        }
                    },
                    // Mantener el valor inicial renderizado por el servidor
                    initSelection: function (element, callback) {
                        if (currentOption.length) {
                            callback({id: currentOption.val(), text: currentOption.text()});
                        }
                    }
                });
            }
        })();
    </script>

    <script>
        (function () {
            // Inicialización general
            $('.select2').select2({
                theme: 'bootstrap4',
                width: '100%'
            });

            // Select de Ficha con carga por API
            var $ficha = $('#id_ficha');
            if ($ficha.length) {
                var apiUrl = $ficha.attr('data-api-url') || '/kardex/api/api_pacientes/';
                var currentOption = $ficha.find('option:selected');
                $ficha.select2({
                    theme: 'bootstrap4',
                    width: '100%',
                    placeholder: $ficha.data('placeholder') || 'Buscar por número de ficha',
                    allowClear: true,
                    minimumInputLength: 1,
                    ajax: {
                        transport: function (params, success, failure) {
                            var term = params.data.term || '';
                            if (!term) {
                                success({results: []});
                                return;
                            }
                            $.ajax({
                                url: apiUrl,
                                method: 'GET',
                                data: {numero_ficha: term},
                                success: function (resp) {
                                    var results = [];
                                    if (resp && resp.exists && resp.has_ficha && resp.data) {
                                        var d = resp.data;
                                        results.push({
                                            id: d.ficha_id,
                                            text: d.numero_ficha_sistema + ' - ' +
                                                (d.nombre || '') + ' ' +
                                                (d.apellido_paterno || '') + ' ' +
                                                (d.apellido_materno || '')
                                        });
                                    }
                                    success({results: results});
                                },
                                error: function (xhr) {
                                    failure(xhr);
                                }
                            });
                        },
                        processResults: function (data) {
                            return data;
                        }
                    },
                    initSelection: function (element, callback) {
                        if (currentOption.length) {
                            callback({
                                id: currentOption.val(),
                                text: currentOption.text()
                            });
                        }
                    }
                });
            }

            // Función para establecer fecha actual automáticamente
            function setTodayIfEmpty(fieldId) {
                var field = document.getElementById(fieldId);
                if (field && !field.value) {
                    var today = new Date().toISOString().split('T')[0];
                    field.value = today;
                }
            }

            // Función para manejar automáticamente la fecha de envío
            function handleFechaEnvio() {
                var estadoEnvio = $('#id_estado_envio').val();
                if (estadoEnvio === 'ENVIADO') {
                    setTodayIfEmpty('id_fecha_envio_date');
                }
            }

            // Función para manejar automáticamente la fecha de recepción
            function handleFechaRecepcion() {
                var estadoRecepcion = $('#id_estado_recepcion').val();
                if (estadoRecepcion === 'RECIBIDO') {
                    setTodayIfEmpty('id_fecha_recepcion_date');
                }
            }

            // Función para manejar automáticamente la fecha de traspaso
            function handleFechaTraspaso() {
                var estadoTraspaso = $('#id_estado_traspaso').val();
                if (estadoTraspaso === 'TRASPASADO') {
                    setTodayIfEmpty('id_fecha_traspaso_date');
                }
            }

            // Configurar event listeners para cambios en los estados
            $('#id_estado_envio').on('change', handleFechaEnvio);
            $('#id_estado_recepcion').on('change', handleFechaRecepcion);
            $('#id_estado_traspaso').on('change', handleFechaTraspaso);

            // Ejecutar al cargar la página para establecer valores iniciales
            $(document).ready(function () {
                // Verificar si ya hay valores seleccionados en los estados
                handleFechaEnvio();
                handleFechaRecepcion();
                handleFechaTraspaso();

                // También establecer fecha actual en campos vacíos al cargar
                setTodayIfEmpty('id_fecha_envio_date');
                setTodayIfEmpty('id_fecha_recepcion_date');
                setTodayIfEmpty('id_fecha_traspaso_date');
            });

            // Manejar envío del formulario - asegurar que los campos de fecha estén llenos
            $('form').on('submit', function (e) {
                // Si algún campo de estado está activo pero no tiene fecha, asignar hoy
                if ($('#id_estado_envio').val() === 'ENVIADO' && !$('#id_fecha_envio_date').val()) {
                    var today = new Date().toISOString().split('T')[0];
                    $('#id_fecha_envio_date').val(today);
                }

                if ($('#id_estado_recepcion').val() === 'RECIBIDO' && !$('#id_fecha_recepcion_date').val()) {
                    var today = new Date().toISOString().split('T')[0];
                    $('#id_fecha_recepcion_date').val(today);
                }

                if ($('#id_estado_traspaso').val() === 'TRASPASADO' && !$('#id_fecha_traspaso_date').val()) {
                    var today = new Date().toISOString().split('T')[0];
                    $('#id_fecha_traspaso_date').val(today);
                }
            });

        })();
    </script>
{% endblock %}