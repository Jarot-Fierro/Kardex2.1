{% extends 'base.html' %}
{% load static %}

{% block title %}Salida de Fichas{% endblock %}

{% block content %}
    <div class="container-fluid small-input">
        <!-- Formulario de Registro (Arriba) -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card card-primary card-outline">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-plus mr-1"></i> Registrar Salida de Ficha</h3>
                    </div>
                    <div class="card-body">
                        <form id="form-salida" method="post" novalidate>
                            {% csrf_token %}
                            {{ form.ficha_id_hidden }}

                            <div class="row">
                                <!-- RUT y Búsqueda -->
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label class="font-weight-bold text-primary">
                                            <i class="fas fa-id-card mr-1"></i> {{ form.rut.label }}
                                        </label>
                                        {{ form.rut }}
                                        <small class="form-text text-muted">Ingrese RUT y presione Tab o Enter.</small>
                                    </div>
                                </div>

                                <!-- Nombre Paciente (Autocompletado) -->
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>{{ form.nombre.label }}</label>
                                        {{ form.nombre }}
                                    </div>
                                </div>

                                <!-- N° Ficha (Autocompletado) -->
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>{{ form.ficha.label }}</label>
                                        {{ form.ficha }}
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>{{ form.servicio_clinico_envio.label }}</label>
                                        {{ form.servicio_clinico_envio }}
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>{{ form.servicio_clinico_recepcion.label }}</label>
                                        {{ form.servicio_clinico_recepcion }}
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>{{ form.profesional_envio.label }}</label>
                                        {{ form.profesional_envio }}
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>{{ form.observacion_envio.label }}</label>
                                        {{ form.observacion_envio }}
                                    </div>
                                </div>
                            </div>

                            <div class="row mt-2">
                                <div class="col-12 text-right">
                                    <button type="button" id="btn-limpiar" class="btn btn-default mr-2">
                                        <i class="fas fa-eraser"></i> Limpiar
                                    </button>
                                    <button type="submit" id="btn-registrar" class="btn btn-primary px-5" disabled>
                                        <i class="fas fa-save mr-1"></i> Registrar Salida
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros (Al medio) -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card card-outline card-secondary">
                    <div class="card-header p-2">
                        <h3 class="card-title ml-2"><i class="fas fa-filter mr-1"></i> Filtros de Historial</h3>
                    </div>
                    <div class="card-body p-2">
                        <form id="form-filtros" method="get">
                            <div class="row">
                                <div class="form-group col-md-3 mb-0">
                                    <label class="mb-1 small">{{ filter_form.hora_inicio.label }}</label>
                                    {{ filter_form.hora_inicio }}
                                </div>
                                <div class="form-group col-md-3 mb-0">
                                    <label class="mb-1 small">{{ filter_form.hora_termino.label }}</label>
                                    {{ filter_form.hora_termino }}
                                </div>
                                <div class="form-group col-md-3 mb-0">
                                    <label class="mb-1 small">{{ filter_form.servicio_clinico.label }}</label>
                                    {{ filter_form.servicio_clinico }}
                                </div>
                                <div class="form-group col-md-2 mb-0">
                                    <label class="mb-1 small">{{ filter_form.profesional.label }}</label>
                                    {{ filter_form.profesional }}
                                </div>
                                <div class="col-md-1 d-flex align-items-end">
                                    <button class="btn btn-secondary btn-block btn-sm" type="submit">
                                        Filtrar
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla (Abajo) -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex align-items-center p-2">
                        <h3 class="card-title ml-2"><i class="fas fa-list mr-1"></i> Historial de Salidas</h3>
                        <div class="ml-auto">
                            <button id="btn-refresh-table" class="btn btn-default btn-sm mr-2">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-2">
                        <table id="Table" class="table table-bordered table-striped table-sm mb-0">
                            <thead>
                            <tr>
                                <th>ID</th>
                                <th>Acciones</th>
                                {% for col in columns %}
                                    {% if col != 'ID' %}
                                        <th>{{ col }}</th>
                                    {% endif %}
                                {% endfor %}
                            </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascript %}
    <script>
        $(document).ready(function () {
            // Inicializar Select2
            $('.select2').select2({
                theme: 'bootstrap4',
                width: '100%'
            });

            const $rut = $('#id_rut');
            const $formSalida = $('#form-salida');
            const $btnRegistrar = $('#btn-registrar');
            const $btnLimpiar = $('#btn-limpiar');

            // Persistencia en localStorage
            const configKeys = [
                'servicio_clinico_ficha', // id_envio
                'servicio_clinico_recepcion',
                'profesional_movimiento',
                'observacion_envio_ficha'
            ];

            function loadConfig() {
                configKeys.forEach(id => {
                    const saved = localStorage.getItem('salida_config_' + id);
                    if (saved) {
                        const $el = $('#' + id);
                        $el.val(saved).trigger('change');
                    }
                });
            }

            function saveConfig() {
                configKeys.forEach(id => {
                    const val = $('#' + id).val();
                    localStorage.setItem('salida_config_' + id, val);
                });
            }

            loadConfig();

            // Guardar config al cambiar campos
            configKeys.forEach(id => {
                $('#' + id).on('change', saveConfig);
            });

            // Foco automático en RUT al cargar
            $rut.focus();

            // Función para limpiar campos de registro
            function limpiarRegistro() {
                $('#id_ficha_hidden').val('');
                $('#id_rut').val('');
                $('#nombre_mov').val('');
                $('#id_ficha').val('');
                $btnRegistrar.prop('disabled', true);
                $rut.focus();
            }

            $btnLimpiar.on('click', limpiarRegistro);

            // Función para formatear RUT (Basada en la de base.html)
            function formatRut(value) {
                let rut = value.replace(/\./g, '').replace(/-/g, '').toUpperCase();
                if (rut.length <= 1) return value;
                let body = rut.slice(0, -1);
                let dv = rut.slice(-1);
                body = body.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                return body + '-' + dv;
            }

            // Búsqueda de paciente al salir del campo RUT (blur) o presionar Enter
            function buscarPaciente() {
                let val = $rut.val().trim();
                if (!val) return;

                // Formatear antes de buscar si parece un RUT
                if (!val.startsWith('PAC-')) {
                    val = formatRut(val);
                    $rut.val(val);
                }

                $.ajax({
                    url: '{% url "ficha-paciente-buscar" %}',
                    data: {q: val},
                    success: function (response) {
                        if (response.results && response.results.length > 0) {
                            const p = response.results[0];
                            if (p.en_transito) {
                                Swal.fire('Advertencia', 'La ficha ya está en tránsito.', 'warning');
                                limpiarRegistro();
                            } else {
                                $('#id_ficha_hidden').val(p.ficha_id);
                                $rut.val(p.rut); // El RUT formateado/limpio que devuelve la API
                                $('#nombre_mov').val(p.nombre_completo);
                                $('#id_ficha').val(p.numero_ficha_sistema);
                                $btnRegistrar.prop('disabled', false);
                            }
                        } else {
                            Swal.fire('No encontrado', 'No se encontró paciente con ese RUT o Ficha en su establecimiento.', 'error');
                            limpiarRegistro();
                        }
                    },
                    error: function () {
                        Swal.fire('Error', 'Error al consultar la base de datos.', 'error');
                        limpiarRegistro();
                    }
                });
            }

            $rut.on('keypress', function (e) {
                if (e.which === 13) {
                    e.preventDefault();
                    buscarPaciente();
                }
            });

            $rut.on('blur', function () {
                buscarPaciente();
            });

            // Registro de salida vía AJAX
            $formSalida.on('submit', function (e) {
                e.preventDefault();

                // Validar que tengamos los datos necesarios
                if (!$('#id_ficha_hidden').val()) {
                    Swal.fire('Error', 'Debe buscar un paciente válido primero.', 'error');
                    return;
                }

                $.ajax({
                    url: window.location.href,
                    method: 'POST',
                    data: $(this).serialize(),
                    headers: {'X-Requested-With': 'XMLHttpRequest'},
                    success: function (response) {
                        if (response.success) {
                            Swal.fire({
                                title: '¡Éxito!',
                                text: response.message,
                                icon: 'success',
                                timer: 1500,
                                showConfirmButton: false
                            });
                            limpiarRegistro();
                            $('#Table').DataTable().ajax.reload(null, false);
                            $rut.focus();
                        } else {
                            Swal.fire('Error', response.error || 'No se pudo registrar.', 'error');
                        }
                    },
                    error: function (xhr) {
                        const err = xhr.responseJSON ? xhr.responseJSON.error : 'Error en el servidor';
                        Swal.fire('Error', err, 'error');
                    }
                });
            });

            // Refresh table button
            $('#btn-refresh-table').on('click', function () {
                $('#Table').DataTable().ajax.reload();
            });

            // Filtros de tabla
            $('#form-filtros').on('submit', function (e) {
                e.preventDefault();
                const params = $(this).serialize();
                const newUrl = window.location.pathname + '?' + params;
                // Actualizar la URL del DataTable
                $('#Table').DataTable().ajax.url(newUrl + '&datatable=1').load();
            });
        });
    </script>
{% endblock %}
